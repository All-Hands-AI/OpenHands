import asyncio
import base64
import json
import os
import shutil
import tempfile

from evaluation.utils.shared import (
    get_default_sandbox_config_for_eval,
    get_openhands_config_for_eval,
)
from openhands.controller.state.state import State
from openhands.core.config import (
    LLMConfig,
    OpenHandsConfig,
    get_agent_config_arg,
    get_evaluation_parser,
    get_llm_config_arg,
)
from openhands.core.config.agent_config import AgentConfig
from openhands.core.logger import openhands_logger as logger
from openhands.core.main import create_runtime, run_controller
from openhands.events.action import CmdRunAction, MessageAction
from openhands.events.observation import BrowserOutputObservation, CmdOutputObservation
from openhands.runtime.base import Runtime
from openhands.utils.async_utils import call_async_from_sync

def get_config(
    task_name: str,
    mount_path_on_host: str,
    llm_config: LLMConfig,
    agent_config: AgentConfig | None,
) -> OpenHandsConfig:
    sandbox_config = get_default_sandbox_config_for_eval()
    sandbox_config.base_container_image = "leandermaben7/pb-env:1.0.0"
    #Docker image built using https://github.com/openai/frontier-evals/blob/main/project/paperbench/paperbench/Dockerfile.base
    sandbox_config.enable_auto_lint = True
    # If the web services are running on the host machine, this must be set to True
    sandbox_config.use_host_network = True #TODO: Check if this is needed
    config = get_openhands_config_for_eval(
        max_iterations=100,
        # we mount trajectories path so that trajectories, generated by OpenHands
        # controller, can be accessible to the evaluator file in the runtime container
        sandbox_config=sandbox_config,
        workspace_mount_path=mount_path_on_host,
    )
    config.save_trajectory_path = os.path.join(
        mount_path_on_host, f'traj_{task_name}.json'
    )
    """
    TODO: Closer look into configs
    """
    config.max_budget_per_task = 25
    config.set_llm_config(llm_config)
    if agent_config:
        config.set_agent_config(agent_config)
    else:
        logger.info('Agent config not provided, using default settings')
        agent_config = AgentConfig(
            enable_prompt_extensions=False,
        )
        config.set_agent_config(agent_config)
    return config


def init_task_env(runtime: Runtime, task_name: str, mount_path_on_host: str):
    #TODO: Workspace is set /workspace - Check if it is a problem
    #TODO: Need to give HF, API_KEYS
    #TODO: Fix git lfs issues
    logger.info(f'{"-" * 50} BEGIN Runtime Initialization Fn {"-" * 50}')

    shutil.copy("evaluation/benchmarks/paper_bench/instructions.md", mount_path_on_host)


    command = f"""rm -rf /home/paper && \
apt-get update && apt-get install -y git-lfs && \
git clone --filter=blob:none --no-checkout https://github.com/openai/frontier-evals.git /tmp/frontier-evals && \
cd /tmp/frontier-evals && \
git lfs install && \
git sparse-checkout init --cone && \
git sparse-checkout set project/paperbench/data/papers/{task_name} && \
git checkout main && \
git lfs pull && \
mkdir -p /home/paper && \
cp -r project/paperbench/data/papers/{task_name}/* /home/paper/
"""
    action = CmdRunAction(command=command)
    action.set_hard_timeout(900)
    logger.info(action, extra={'msg_type': 'ACTION'})
    obs = runtime.run_action(action)
    logger.info(obs, extra={'msg_type': 'OBSERVATION'})
    assert obs.exit_code == 0
    logger.info("Copying instructions.md to /home")
    runtime.copy_to(os.path.join("evaluation/benchmarks/paper_bench", 'instructions.md'), '/home')
    logger.info(f'{"-" * 50} END Runtime Initialization Fn {"-" * 50}')


def codeact_user_response(state: State) -> str:
    msg = (
        'Please continue working on the task on whatever approach you think is suitable.\n'
        'If you think you have solved the task, please finish the interaction.\n'
        'IMPORTANT: YOU SHOULD NEVER ASK FOR HUMAN HELP.\n'
    )

    if state.history:
        # check if the agent has tried to talk to the user 3 times, if so, let the agent know it can give up
        user_msgs = [
            event
            for event in state.history
            if isinstance(event, MessageAction) and event.source == 'user'
        ]
        if len(user_msgs) >= 2:
            # let the agent know that it can give up when it has tried 3 times
            return (
                msg
                + 'If you want to give up, run: <execute_bash> exit </execute_bash>.\n'
            )
    return msg


def run_solver(
    runtime: Runtime,
    task_name: str,
    config: OpenHandsConfig,
    save_final_state: bool,
    state_dir: str,
    save_screenshots: bool,
    screenshots_dir: str,
    submission_dir: str,
) -> State:
    instruction = "Complete the task in /home/instructions.md"

    state: State | None = asyncio.run(
        run_controller(
            config=config,
            sid=task_name,
            initial_user_action=MessageAction(content=instruction),
            runtime=runtime,
            fake_user_response_fn=codeact_user_response,
        )
    )
    logger.info(state)

    if save_screenshots:
        screenshots_dir = os.path.join(screenshots_dir, task_name)
        os.makedirs(screenshots_dir, exist_ok=True)
        for image_id, obs in enumerate(state.history):
            if isinstance(obs, BrowserOutputObservation):
                image_data = base64.b64decode(
                    obs.screenshot.replace('data:image/png;base64,', '')
                )
                with open(
                    os.path.join(screenshots_dir, f'{image_id}.png'), 'wb'
                ) as file:
                    file.write(image_data)
                if obs.set_of_marks:
                    som_image_data = base64.b64decode(
                        obs.set_of_marks.replace('data:image/png;base64,', '')
                    )
                    with open(
                        os.path.join(screenshots_dir, f'{image_id}_som.png'), 'wb'
                    ) as file:
                        file.write(som_image_data)

    if save_final_state:
        os.makedirs(state_dir, exist_ok=True)
        with open(os.path.join(state_dir, f'state_{task_name}.json'), 'w') as file:
            json.dump(str(state), file)

    tempfile_path = runtime.copy_from('/home/submission')
    print(f"Submission copied from /home/submission to {tempfile_path}")
    shutil.move(tempfile_path, os.path.join(submission_dir, f'submission_{task_name}.py'))

    return state


if __name__ == '__main__':
    parser = get_evaluation_parser()
    parser.add_argument(
        '--task-name',
        type=str,
        default=None,
        help='Task name',
    )
    parser.add_argument(
        '--outputs-path',
        type=str,
        default='./outputs',
        help='Folder path to save trajectories',
    )
    parser.add_argument(
        '--agent-llm-config',
        type=str,
        default=None,
        help='LLM config for agent',
    )
    args, _ = parser.parse_known_args()

    agent_config: AgentConfig | None = None
    if args.agent_config:
        agent_config = get_agent_config_arg(args.agent_config)

    agent_llm_config: LLMConfig | None = None
    if args.agent_llm_config:
        agent_llm_config = get_llm_config_arg(args.agent_llm_config)

    if agent_llm_config is None:
        raise ValueError(
            f'Could not find LLM config for agent: --agent-llm-config {args.agent_llm_config}'
        )

    if agent_llm_config.api_key is None:
        raise ValueError('LLM API key is not set for agent')

    if os.getenv('TMPDIR') and os.path.exists(os.getenv('TMPDIR')):
        temp_dir = os.path.abspath(os.getenv('TMPDIR'))
    else:
        temp_dir = tempfile.mkdtemp()
    os.chmod(temp_dir, 0o777)
    config: OpenHandsConfig = get_config(
        args.task_name, temp_dir, agent_llm_config, agent_config
    )
    runtime: Runtime = create_runtime(config)
    call_async_from_sync(runtime.connect)
    init_task_env(runtime, args.task_name, temp_dir)

    state = run_solver(
        runtime,
        args.task_name,
        config,
        save_final_state=True,
        state_dir=os.path.abspath(args.outputs_path),
        save_screenshots=True,
        screenshots_dir=os.path.join(os.path.abspath(args.outputs_path), 'screenshots'),
        submission_dir=os.path.join(os.path.abspath(args.outputs_path), f'submissions/{args.task_name}'),
    )

    # finally, move trajectory file from mount path on host (temp dir) to outputs path
    shutil.move(
        os.path.join(temp_dir, f'traj_{args.task_name}.json'),
        os.path.join(
            os.path.abspath(args.outputs_path), f'traj_{args.task_name}.json'
        ),
    )
