# OSX/Windows users: Ensure you increase the ram of docker machine 

services:
  frontend:
    build:
      context: frontend
    image: localhost/devin-frontend-image:latest
    networks:
      - opendevin
    ports:
      - "3001:3001"
    container_name: devin-frontend
    # volumes:
      # - workspace:/usr/src/app/workspace
    # depends_on:
      # backend:
        # condition: service_healthy
    environment:
      - BACKEND_HOST=devin-backend:3000
    command: ["npm", "start", "--", "--host", "0.0.0.0"]

  backend:
    build:
      context: .
    image: localhost/devin-backend-image:latest
    networks:
      - opendevin
    ports:
      - "3000:3000"
    container_name: devin-backend
    volumes:
      - type: bind
        source: ./config.toml
        target: /usr/src/app/config.toml
      # When using podman change source to the podman socket (see podman desktop to copy/paste)
      # unix:///var/folders/r3/hy7xk2kd6ms83c026dddzcnc0000gn/T/podman/podman-machine-default-api.sock
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
      - type: bind
        source: ./workspace
        target: /usr/src/app/workspace
    # volumes_from:
    #   - "frontend:rw"
    privileged: true
    command: ["poetry", "run", "uvicorn", "opendevin.server.listen:app", "--host", "0.0.0.0", "--port", "3000", "--log-level", "debug"]
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:3000/api"]
    #   interval: 1s
    #   timeout: 5s
    #   retries: 5
    #   start_period: 10s

networks:
  opendevin:
    name: opendevin
    driver: bridge

# volumes:
#   workspace:
#     driver: local
