# Manual workflow for testing tagged and feature branch releases before merging
# This workflow allows testing connectivity and keys for prerelease builds
name: Publish to S3

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build from (e.g., 1.0.0)'
        required: true
        type: string
        default: '1.0.0'

concurrency:
  group: s3-release-${{ github.run_id }}
  cancel-in-progress: false

env:
  TAG: ${{ inputs.tag }}
  TAG_FOLDER: releases/${{ inputs.tag }}
  DOCKER_REGISTRY: all-hands-ai
  IMAGE_URI: ghcr.io/all-hands-ai/enterprise-server

jobs:
  publish-enterprise-server:
    name: Publish Enterprise Server
    runs-on: ubuntu-latest
    outputs:
      presigned-url: ${{ steps.presigned-url.outputs.presigned-url }}
      file-size: ${{ steps.file-size.outputs.size }}
    steps:
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull and export enterprise-server image
        run: |
          echo "Pulling enterprise-server image for tag: ${{ env.TAG }}"
          
          # Pull the image from GHCR
          docker pull ${{ env.IMAGE_URI }}:${{ env.TAG }}
          
          # Export to tarball
          docker save ${{ env.IMAGE_URI }}:${{ env.TAG }} | gzip > enterprise-server-${{ env.TAG }}.tar.gz
          
          echo "âœ… Enterprise-server image exported"
      
      - name: Upload image to S3
        run: |
          echo "Uploading enterprise-server image to S3..."
          
          # Upload the tarball
          aws s3 cp enterprise-server-${{ env.TAG }}.tar.gz "s3://${{ vars.AWS_RELEASE_BUCKET }}/${{ env.TAG_FOLDER }}/enterprise-server-${{ env.TAG }}.tar.gz"
          
          echo "âœ… Image uploaded to S3"
      
      - name: Generate presigned URL
        id: presigned-url
        uses: ./.github/actions/generate-presigned-url
        with:
          bucket: ${{ vars.AWS_RELEASE_BUCKET }}
          key: ${{ env.TAG_FOLDER }}/enterprise-server-${{ env.TAG }}.tar.gz
          region: ${{ secrets.AWS_REGION || 'us-east-1' }}
          expires-in: '604800'
      
      - name: Get file size
        id: file-size
        run: |
          SIZE=$(stat -c%s "enterprise-server-${{ env.TAG }}.tar.gz")
          echo "size=$SIZE bytes" >> $GITHUB_OUTPUT

  publish-runtime-nikolaik:
    name: Publish Runtime Nikolaik
    runs-on: ubuntu-latest
    outputs:
      presigned-url: ${{ steps.presigned-url.outputs.presigned-url }}
      file-size: ${{ steps.file-size.outputs.size }}
    steps:
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull and export runtime-nikolaik image
        run: |
          echo "Pulling runtime-nikolaik image for tag: ${{ env.TAG }}"
          
          # Pull the image from GHCR
          docker pull ghcr.io/all-hands-ai/runtime:${{ env.TAG }}-nikolaik
          
          # Export to tarball
          docker save ghcr.io/all-hands-ai/runtime:${{ env.TAG }}-nikolaik | gzip > runtime-nikolaik-${{ env.TAG }}.tar.gz
          
          echo "âœ… Runtime-nikolaik image exported"
      
      - name: Upload image to S3
        run: |
          echo "Uploading runtime-nikolaik image to S3..."
          
          # Upload the tarball
          aws s3 cp runtime-nikolaik-${{ env.TAG }}.tar.gz "s3://${{ vars.AWS_RELEASE_BUCKET }}/${{ env.TAG_FOLDER }}/runtime-nikolaik-${{ env.TAG }}.tar.gz"
          
          echo "âœ… Image uploaded to S3"
      
      - name: Generate presigned URL
        id: presigned-url
        uses: ./.github/actions/generate-presigned-url
        with:
          bucket: ${{ vars.AWS_RELEASE_BUCKET }}
          key: ${{ env.TAG_FOLDER }}/runtime-nikolaik-${{ env.TAG }}.tar.gz
          region: ${{ secrets.AWS_REGION || 'us-east-1' }}
          expires-in: '604800'
      
      - name: Get file size
        id: file-size
        run: |
          SIZE=$(stat -c%s "runtime-nikolaik-${{ env.TAG }}.tar.gz")
          echo "size=$SIZE bytes" >> $GITHUB_OUTPUT

  publish-runtime-ubuntu:
    name: Publish Runtime Ubuntu
    runs-on: ubuntu-latest
    outputs:
      presigned-url: ${{ steps.presigned-url.outputs.presigned-url }}
      file-size: ${{ steps.file-size.outputs.size }}
    steps:
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull and export runtime-ubuntu image
        run: |
          echo "Pulling runtime-ubuntu image for tag: ${{ env.TAG }}"
          
          # Pull the image from GHCR
          docker pull ghcr.io/all-hands-ai/runtime:${{ env.TAG }}-ubuntu
          
          # Export to tarball
          docker save ghcr.io/all-hands-ai/runtime:${{ env.TAG }}-ubuntu | gzip > runtime-ubuntu-${{ env.TAG }}.tar.gz
          
          echo "âœ… Runtime-ubuntu image exported"
      
      - name: Upload image to S3
        run: |
          echo "Uploading runtime-ubuntu image to S3..."
          
          # Upload the tarball
          aws s3 cp runtime-ubuntu-${{ env.TAG }}.tar.gz "s3://${{ vars.AWS_RELEASE_BUCKET }}/${{ env.TAG_FOLDER }}/runtime-ubuntu-${{ env.TAG }}.tar.gz"
          
          echo "âœ… Image uploaded to S3"
      
      - name: Generate presigned URL
        id: presigned-url
        uses: ./.github/actions/generate-presigned-url
        with:
          bucket: ${{ vars.AWS_RELEASE_BUCKET }}
          key: ${{ env.TAG_FOLDER }}/runtime-ubuntu-${{ env.TAG }}.tar.gz
          region: ${{ secrets.AWS_REGION || 'us-east-1' }}
          expires-in: '604800'
      
      - name: Get file size
        id: file-size
        run: |
          SIZE=$(stat -c%s "runtime-ubuntu-${{ env.TAG }}.tar.gz")
          echo "size=$SIZE bytes" >> $GITHUB_OUTPUT

  create-release-report:
    name: Create Release Report
    needs: [publish-enterprise-server, publish-runtime-nikolaik, publish-runtime-ubuntu]
    runs-on: ubuntu-latest
    steps:
      - name: Create comprehensive S3 publish report
        id: create-report
        uses: ./.github/actions/s3-publish-report
        with:
          tag: ${{ env.TAG }}
          bucket: ${{ vars.AWS_RELEASE_BUCKET }}
          tag-folder: ${{ env.TAG_FOLDER }}
          images: |
            [
              {
                "name": "enterprise-server",
                "displayName": "Enterprise Server",
                "filename": "enterprise-server-${{ env.TAG }}.tar.gz",
                "url": "${{ needs.publish-enterprise-server.outputs.presigned-url }}",
                "size": "${{ needs.publish-enterprise-server.outputs.file-size }}",
                "description": "Main OpenHands enterprise application server"
              },
              {
                "name": "runtime-nikolaik",
                "displayName": "Runtime (Nikolaik)",
                "filename": "runtime-nikolaik-${{ env.TAG }}.tar.gz",
                "url": "${{ needs.publish-runtime-nikolaik.outputs.presigned-url }}",
                "size": "${{ needs.publish-runtime-nikolaik.outputs.file-size }}",
                "description": "Runtime environment based on Debian (Nikolaik)"
              },
              {
                "name": "runtime-ubuntu",
                "displayName": "Runtime (Ubuntu)",
                "filename": "runtime-ubuntu-${{ env.TAG }}.tar.gz",
                "url": "${{ needs.publish-runtime-ubuntu.outputs.presigned-url }}",
                "size": "${{ needs.publish-runtime-ubuntu.outputs.file-size }}",
                "description": "Runtime environment based on Ubuntu"
              }
            ]
          repository: ${{ github.repository }}
          run-id: ${{ github.run_id }}
          url-length: 'unknown'
          expires-at: '7 days'
      
      - name: Upload HTML report artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-report-${{ env.TAG }}
          path: ${{ steps.create-report.outputs.report-path }}
      
      - name: Output build information
        run: |
          echo ""
          echo "## ðŸŽ‰ Publish to S3 Complete!"
          echo ""
          echo "**Tag**: \`${{ env.TAG }}\`"
          echo "**S3 Location**: \`s3://${{ vars.AWS_RELEASE_BUCKET }}/${{ env.TAG_FOLDER }}/\`"
          echo ""
          echo "### ðŸ“¦ Available Images:"
          echo "- \`enterprise-server-${{ env.TAG }}.tar.gz\`"
          echo "- \`runtime-nikolaik-${{ env.TAG }}.tar.gz\`"
          echo "- \`runtime-ubuntu-${{ env.TAG }}.tar.gz\`"
          echo ""
          echo "### ðŸ“‹ Download Information:"
          echo "- View the release report in the \`release-report-${{ env.TAG }}\` artifact"
          echo "- Report file: \`${{ steps.create-report.outputs.report-path }}\`"
          echo "- Report size: \`${{ steps.create-report.outputs.report-size }} bytes\`"
          echo "- The HTML report contains all download links and usage instructions"
          echo ""
