# Manual workflow for testing tagged and feature branch releases before merging
# This workflow allows testing connectivity and keys for prerelease builds
name: Publish to S3

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build from (e.g., 1.0.0)'
        required: true
        type: string
        default: '1.0.0'

concurrency:
  group: s3-release-${{ github.run_id }}
  cancel-in-progress: false

env:
  TAG: ${{ inputs.tag }}
  TAG_FOLDER: releases/${{ inputs.tag }}
  DOCKER_REGISTRY: all-hands-ai
  IMAGE_URI: ghcr.io/all-hands-ai/enterprise-server

jobs:
  publish-to-s3:
    name: Publish to S3
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull and export enterprise-server image
        run: |
          echo "Pulling enterprise-server image for tag: ${{ env.TAG }}"
          
          # Pull the image from GHCR
          docker pull ${{ env.IMAGE_URI }}:${{ env.TAG }}
          
          # Export to tarball
          docker save ${{ env.IMAGE_URI }}:${{ env.TAG }} | gzip > enterprise-server-${{ env.TAG }}.tar.gz
          
          echo "âœ… Enterprise-server image exported"
      
      - name: Prepare S3 upload
        run: |
          # S3 will automatically create the path structure when we upload the file
          echo "S3 upload path:"
          echo "  Tag folder: ${{ env.TAG_FOLDER }}"
          echo "  File: enterprise-server-${{ env.TAG }}.tar.gz"
      
      - name: Upload image to S3
        run: |
          echo "Uploading enterprise-server image to S3..."
          
          # Upload the tarball
          aws s3 cp enterprise-server-${{ env.TAG }}.tar.gz "s3://${{ vars.AWS_RELEASE_BUCKET }}/${{ env.TAG_FOLDER }}/enterprise-server-${{ env.TAG }}.tar.gz"
          
          echo "âœ… Image uploaded to S3"
      
      - name: Generate presigned URL
        id: presigned-url
        run: |
          echo "Generating presigned URL (valid for 7 days)..."
          echo "Using read-only role to minimize credential exposure in pre-signed URLs"
          
          # Step 1: Assume read-only role for pre-signed URL generation
          echo "Assuming read-only role for pre-signed URL generation..."
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ROLE_CREDS=$(aws sts assume-role \
            --role-arn "arn:aws:iam::${ACCOUNT_ID}:role/S3PresignedURLRole" \
            --role-session-name "presigned-url-session" \
            --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
            --output text)
          
          # Step 2: Extract credentials for the read-only role
          IFS=$'\t' read -r AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN <<< "$ROLE_CREDS"
          export AWS_ACCESS_KEY_ID
          export AWS_SECRET_ACCESS_KEY
          export AWS_SESSION_TOKEN
          
          # Step 3: Generate pre-signed URL with temporary read-only credentials
          presigned_url=$(aws s3 presign "s3://${{ vars.AWS_RELEASE_BUCKET }}/${{ env.TAG_FOLDER }}/enterprise-server-${{ env.TAG }}.tar.gz" --expires-in 604800)
          echo "PRESIGNED_URL=$presigned_url" >> $GITHUB_OUTPUT
          echo "Generated presigned URL with read-only credentials"
            
      - name: Output build information
        run: |
          echo ""
          echo "## ðŸŽ‰ Publish to S3 Complete!"
          echo ""
          echo "**Tag**: \`${{ env.TAG }}\`"
          echo "**S3 Location**: \`s3://${{ vars.AWS_RELEASE_BUCKET }}/${{ env.TAG_FOLDER }}/\`"
          echo ""
          echo "### ðŸ“¦ Available Image:"
          echo "- \`enterprise-server-${{ env.TAG }}.tar.gz\`"
          echo ""
          echo "### ðŸ”— Download Link (valid for 30 days):"
          echo "- [enterprise-server-${{ env.TAG }}.tar.gz](${{ steps.presigned-url.outputs.PRESIGNED_URL }})"
          echo ""
