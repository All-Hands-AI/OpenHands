
name: Regenerate Integration Tests

on:
  workflow_dispatch:

jobs:
  regenerate_integration_tests:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install poetry via pipx
      run: pipx install poetry
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'poetry'
    - name: Install Python dependencies using Poetry
      run: poetry install --without evaluation,llama-index

    - name: Install & Start Docker
      if: env.INSTALL_DOCKER == '1'
      run: |
        INSTANCE_NAME="colima-${GITHUB_RUN_ID}"

        # Uninstall colima to upgrade to the latest version
        if brew list colima &>/dev/null; then
          brew uninstall colima
          # unlinking colima dependency: go
          brew uninstall go@1.21
        fi
        rm -rf ~/.colima ~/.lima
        brew install --HEAD colima
        brew install docker

        start_colima() {
          # Find a free port in the range 10000-20000
          RANDOM_PORT=$((RANDOM % 10001 + 10000))

          # Original line:
          if ! colima start --network-address --arch x86_64 --cpu=1 --memory=1 --verbose --ssh-port $RANDOM_PORT; then
            echo "Failed to start Colima."
            return 1
          fi
          return 0
        }

        # Attempt to start Colima for 5 total attempts:
        ATTEMPT_LIMIT=5
        for ((i=1; i<=ATTEMPT_LIMIT; i++)); do

          if start_colima; then
            echo "Colima started successfully."
            break
          else
            colima stop -f
            sleep 10
            colima delete -f
            if [ $i -eq $ATTEMPT_LIMIT ]; then
              exit 1
            fi
            sleep 10
          fi
        done

        # For testcontainers to find the Colima socket
        # https://github.com/abiosoft/colima/blob/main/docs/FAQ.md#cannot-connect-to-the-docker-daemon-at-unixvarrundockersock-is-the-docker-daemon-running
        sudo ln -sf $HOME/.colima/default/docker.sock /var/run/docker.sock

    - name: Build Environment
      run: make build

    - name: Regenerate integration tests
      run: ./tests/integration/regenerate.sh

    - name: Commit changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add .
        git commit -m "Regenerate integration tests"
        git push
