name: Check Package Versions

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  check-package-versions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check for commit-hash revs in pyproject.toml
        run: |
          python - <<'PY'
          import sys, re, tomllib, pathlib

          path = pathlib.Path("pyproject.toml")

          if not path.exists():
              print("ERROR: pyproject.toml not found")
              sys.exit(1)

          try:
              data = tomllib.loads(path.read_text(encoding="utf-8"))
          except Exception as e:
              print(f"ERROR: Failed to parse pyproject.toml: {e}")
              sys.exit(1)

          deps = (
              data.get("tool", {})
                  .get("poetry", {})
                  .get("dependencies", {})
          )

          if not isinstance(deps, dict) or not deps:
              print("ERROR: No dependencies found under tool.poetry.dependencies")
              sys.exit(1)

          print("ðŸ” Checking all dependencies for commit-hash revs...\n")
          commit_hash = re.compile(r"^[0-9a-f]{7,40}$", re.IGNORECASE)
          errors = []

          for name, cfg in deps.items():
              if isinstance(cfg, str):
                  print(f"  â€¢ {name}: version '{cfg}' (OK)")
                  continue

              if isinstance(cfg, dict):
                  rev = cfg.get("rev")
                  if rev:
                      if commit_hash.match(str(rev)):
                          msg = f"  âœ– {name}: rev='{rev}' looks like a commit hash (NOT ALLOWED)"
                          print(msg)
                          errors.append(msg)
                      else:
                          print(f"  â€¢ {name}: rev='{rev}' (tag/branch OK)")
                  elif "version" in cfg:
                      print(f"  â€¢ {name}: version '{cfg['version']}' (OK)")
                  elif "git" in cfg:
                      print(f"  â€¢ {name}: git dependency without rev (WARN, allowed)")
                  else:
                      print(f"  â€¢ {name}: unusual config {cfg!r} (OK)")
                  continue

              print(f"  â€¢ {name}: unexpected format {type(cfg).__name__} (OK)")

          if errors:
              print("\nâŒ FAILED: Found dependencies pinned to commit hashes:\n" + "\n".join(errors))
              print("\nUse released versions or tag/branch names instead, e.g.:")
              print('  my-package = "1.0.0"')
              print('  my-package = { git = "...", rev = "v1.0.0" }')
              sys.exit(1)

          print("\nâœ… SUCCESS: No forbidden commit-hash revs found.")
          PY
