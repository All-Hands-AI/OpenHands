# Workflow that builds and tests the CLI binary executable
name: CLI - Build binary and optionally release

# Run on pushes to main branch and CLI tags, and on pull requests when CLI files change
on:
  push:
    branches:
      - main
    paths:
      - "openhands-cli/**"
      - ".github/workflows/cli-build-binary-and-optionally-release.yml"
      - "dev_config/**"
    tags:
      - "*-cli"
  pull_request:
    paths:
      - "openhands-cli/**"
  workflow_dispatch:
    inputs:
      fast:
        description: "Skip PyInstaller packaging (fast validation run)"
        type: boolean
        default: false

permissions:
  contents: write       # needed to create releases or upload assets

# Cancel previous runs if a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ (github.head_ref && github.ref) || github.run_id }}
  cancel-in-progress: true

jobs:
  build-binary:
    name: Build binary executable
    strategy:
      matrix:
        include:
          # Build on Ubuntu 22.04 for maximum GLIBC compatibility (GLIBC 2.31)
          - os: ubuntu-22.04
            platform: linux
            artifact_name: openhands-cli-linux
          # Build on macOS for macOS users
          - os: macos-15
            platform: macos
            artifact_name: openhands-cli-macos
    runs-on: ${{ matrix.os }}
    # When fast=true, macOS matrix entries skip steps so only the Linux job runs a pytest smoke.

    steps:
      - name: Checkout repository
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.fast == 'true' && matrix.platform != 'linux') }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.fast == 'true' && matrix.platform != 'linux') }}
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Install uv
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.fast == 'true' && matrix.platform != 'linux') }}
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Install dependencies
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.fast == 'true' && matrix.platform != 'linux') }}
        working-directory: openhands-cli
        run: |
          uv sync

      - name: Fast validation run
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.fast == 'true' && matrix.platform == 'linux' }}
        working-directory: openhands-cli
        run: |
          uv run pytest -q

      - name: Build binary executable
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.fast == 'true') }}
        working-directory: openhands-cli
        run: |
          ./build.sh --install-pyinstaller | tee output.log
          echo "Full output:"
          cat output.log

          if grep -q "❌" output.log; then
            echo "❌ Found failure marker in output"
            exit 1
          fi

          echo "✅ Build & test finished without ❌ markers"

      - name: Verify binary files exist
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.fast == 'true') }}
        run: |
          if ! ls openhands-cli/dist/openhands* 1> /dev/null 2>&1; then
            echo "❌ No binaries found to upload!"
            exit 1
          fi
          echo "✅ Found binaries to upload."

      - name: Upload binary artifact
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.fast == 'true') }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: openhands-cli/dist/openhands*
          retention-days: 30

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-binary
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          # Copy binaries with appropriate names for release
          if [ -f artifacts/openhands-cli-linux/openhands ]; then
            cp artifacts/openhands-cli-linux/openhands release-assets/openhands-linux
          fi
          if [ -f artifacts/openhands-cli-macos/openhands ]; then
            cp artifacts/openhands-cli-macos/openhands release-assets/openhands-macos
          fi
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
